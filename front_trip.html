<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>STEP1: 要件入力 | NEWT biz BTM</title>
    <meta name="description" content="NEWT biz BTMの出張要件入力ページ" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // index.htmlから配色やフォント設定を継承
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
            colors: {
              rt: {
                50: '#ECFDF5',
                100: '#D1FAE5',
                200: '#A7F3D0',
                300: '#6FE7B0',
                400: '#2EDB7B',
                500: '#04cd68ff', // Primary #00CD68 に近い
                600: '#03B75E', // Dark #00B33F に近い
                700: '#029E52',
                800: '#028546',
                900: '#016C39'
              },
              base: '#1F1F1F',
              warning: '#f86363',
            },
            boxShadow: {
              card: "0 6px 24px rgba(0,0,0,0.08)",
            }
          }
        }
      };
    </script>
    <style>
      html { scroll-behavior: smooth; }
      body { background-color: #F6F6F6; } /* ベース背景色を設定 */
    </style>
  </head>
  <body class="antialiased text-slate-800">
    <div id="root"></div>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const Container = ({ children, className = "" }) => (
        <div className={`mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8 ${className}`}>{children}</div>
      );

      // --- 共通UIフレーム ---
      const AppHeader = () => {
        const steps = ["要件入力", "AI提案", "微調整", "承認申請", "上司承認"];
        const currentStep = 1;

        return (
          <header className="bg-white/80 backdrop-blur sticky top-0 z-50 border-b border-slate-200">
            <Container className="flex items-center justify-between h-16">
              {/* 左: ロゴ */}
              <a href="index.html" className="font-bold tracking-tight text-lg">NEWT biz BTM</a>

              {/* 中央: ステッパー */}
              <div className="hidden md:flex items-center gap-4">
                {steps.map((step, index) => (
                  <div key={step} className="flex items-center gap-2">
                    <span className={`flex items-center justify-center w-6 h-6 rounded-full font-bold text-sm ${
                      index + 1 === currentStep ? 'bg-rt-600 text-white' : 'bg-slate-200 text-slate-500'
                    }`}>{index + 1}</span>
                    <span className={`font-semibold ${
                      index + 1 === currentStep ? 'text-rt-600' : 'text-slate-500'
                    }`}>{step}</span>
                    {index < steps.length - 1 && <div className="w-10 h-0.5 bg-slate-200"></div>}
                  </div>
                ))}
              </div>

              {/* 右: ユーザー情報 */}
              <div className="flex items-center gap-4 text-sm">
                <span className="font-semibold">P-NEWT-042</span>
                <span className="bg-slate-100 px-2 py-1 rounded-md">出張者</span>
                <a href="#" className="text-slate-500 hover:text-slate-800">ヘルプ</a>
              </div>
            </Container>
          </header>
        );
      };

      const AppFooter = ({ onBack, onDraft, onNext, nextLabel = 'AIに提案させる', loading }) => (
        <footer className="bg-white/80 backdrop-blur sticky bottom-0 z-50 border-t border-slate-200 py-3">
          <Container className="flex items-center justify-between">
            <button onClick={onBack} className="rounded-md px-4 py-2 text-sm font-semibold border border-slate-300 hover:bg-slate-100">戻る</button>
            <button onClick={onDraft} className="rounded-md px-4 py-2 text-sm font-semibold text-slate-600 hover:text-slate-900">下書き保存</button>
            <button onClick={onNext} disabled={loading} className="rounded-md bg-rt-600 px-6 py-2 text-white font-semibold shadow hover:bg-rt-700 disabled:opacity-60 disabled:cursor-not-allowed">{loading ? '生成中…' : nextLabel}</button>
          </Container>
        </footer>
      );

      // --- 右ペイン: サマリーカード ---
      const StatusBadge = ({ type, children }) => {
        const styles = {
          success: 'bg-emerald-50 text-emerald-700 ring-emerald-200',
          warning: 'bg-amber-50 text-amber-700 ring-amber-200',
          error: 'bg-rose-50 text-rose-700 ring-rose-200',
          info: 'bg-slate-100 text-slate-700 ring-slate-200'
        };
        return <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ring-1 ${styles[type] || styles.info}`}>{children}</span>;
      };

      const SummaryCard = ({ summary }) => (
        <aside className="sticky top-24 space-y-4">
          <div className="bg-white p-5 rounded-lg border border-slate-200 shadow-card">
            <h3 className="font-bold text-lg">サマリー</h3>
            <div className="mt-4 space-y-3 text-sm">
              <div className="flex justify-between"><span>旅程合計</span><span className="font-semibold">¥{summary.total.toLocaleString()}</span></div>
              <div className="flex justify-between"><span>予算</span><span className="font-semibold text-rt-700">航空 ¥{summary.airBudget?.toLocaleString()||0} / 宿 ¥{summary.hotelBudget?.toLocaleString()||0}</span></div>
              <div className="flex justify-between"><span>ポリシー適合度</span><span className="font-semibold text-rt-700">{summary.policyScore}%</span></div>
              <div className="flex items-center justify-between"><span>ポリシー</span><div className="space-x-1">{summary.policyFlags.map((f,i)=>(<StatusBadge key={i} type={f.type}>{f.label}</StatusBadge>))}</div></div>
              <div className="flex justify-between"><span>リスク通知</span><span className="font-semibold">{summary.risks}件</span></div>
              <div className="flex justify-between"><span>承認ステータス</span><span className="bg-slate-100 px-2 py-0.5 rounded-full text-xs">未申請</span></div>
            </div>
          </div>
        </aside>
      );

      // --- STEP1: メインコンテンツ ---
      const Step1Form = ({ value, onChange, errors, onAddFixed }) => {
        const FormSection = ({ title, children }) => (
          <fieldset className="bg-white p-6 rounded-lg border border-slate-200 shadow-card">
            <legend className="text-lg font-bold px-2">{title}</legend>
            <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
              {children}
            </div>
          </fieldset>
        );

        const FormField = ({ label, children, className="" }) => (
          <div className={className}>
            <label className="text-sm font-medium text-slate-700 block">{label}</label>
            <div className="mt-1">{children}</div>
            {errors[label] && <p className="mt-1 text-xs text-rose-600">{errors[label]}</p>}
          </div>
        );

        return (
          <div className="space-y-6">
            <FormSection title="基本">
              <FormField label="目的地（国/都市）" className="md:col-span-2">
                <input defaultValue={value.destination||''} onBlur={e=>onChange({destination:e.target.value})} placeholder="例: 台湾, 台北市" className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="出張目的">
                <select defaultValue={value.purpose||'商談'} onChange={e=>onChange({purpose:e.target.value})} className="w-full rounded-md border-slate-300"><option>商談</option><option>調達</option><option>学会</option><option>撮影</option><option>現場対応</option></select>
              </FormField>
              <FormField label="出発日">
                <input type="date" defaultValue={value.start||''} onBlur={e=>onChange({start:e.target.value})} className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="帰着日">
                <input type="date" defaultValue={value.end||''} onBlur={e=>onChange({end:e.target.value})} className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="発着希望空港">
                <input defaultValue={value.origin||''} onBlur={e=>onChange({origin:e.target.value})} placeholder="例: HND" className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="時間帯希望">
                <select defaultValue={value.timePref||'any'} onChange={e=>onChange({timePref:e.target.value})} className="w-full rounded-md border-slate-300"><option value="any">指定なし</option><option value="morning">朝</option><option value="noon">昼</option><option value="night">夜</option></select>
              </FormField>
            </FormSection>

            <FormSection title="コスト">
              <FormField label="航空券予算（総額）">
                <input type="number" defaultValue={value.airBudget||''} onBlur={e=>onChange({airBudget:Number(e.target.value)})} placeholder="80000" className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="航空券クラス">
                <select defaultValue={value.airClass||'Y'} onChange={e=>onChange({airClass:e.target.value})} className="w-full rounded-md border-slate-300"><option value="Y">エコノミー</option><option value="C">ビジネス</option></select>
              </FormField>
              <FormField label="ホテル予算（1泊上限）">
                <input type="number" defaultValue={value.hotelBudget||''} onBlur={e=>onChange({hotelBudget:Number(e.target.value)})} placeholder="18000" className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="ホテル立地優先度">
                <select defaultValue={value.hotelArea||'near_meeting'} onChange={e=>onChange({hotelArea:e.target.value})} className="w-full rounded-md border-slate-300"><option value="near_meeting">会場近く</option><option value="near_station">駅近く</option><option value="near_airport">空港近く</option></select>
              </FormField>
            </FormSection>

            <FormSection title="固定予定">
               <FormField label="件名" className="md:col-span-2">
                <input defaultValue={value.eventTitle||''} onBlur={e=>onChange({eventTitle:e.target.value})} placeholder="例: 一次商談" className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="場所">
                <input defaultValue={value.eventPlace||''} onBlur={e=>onChange({eventPlace:e.target.value})} placeholder="例: 台北101" className="w-full rounded-md border-slate-300" />
              </FormField>
              <FormField label="開始時刻">
                 <input type="time" defaultValue={value.eventStart||''} onBlur={e=>onChange({eventStart:e.target.value})} className="w-full rounded-md border-slate-300" />
              </FormField>
               <FormField label="終了時刻">
                 <input type="time" defaultValue={value.eventEnd||''} onBlur={e=>onChange({eventEnd:e.target.value})} className="w-full rounded-md border-slate-300" />
              </FormField>
              <div className="md:col-span-2 text-right">
                <button type="button" onClick={onAddFixed} className="text-sm font-semibold text-rt-600 hover:text-rt-700">+ 予定を追加</button>
              </div>
            </FormSection>
             <FormSection title="+α ニーズ（タグ形式）">
                <div className="md:col-span-2 space-x-2">
                    {['深夜見積OK','通訳','会食手配','ビザ要'].map(tag => {
                      const active = value.tags?.includes(tag);
                      return (
                        <button key={tag} type="button" onClick={()=>{ const set = new Set(value.tags||[]); active ? set.delete(tag) : set.add(tag); onChange({tags:[...set]}); }} className={`px-3 py-1 rounded-full text-sm border ${active? 'bg-rt-100 border-rt-300 text-rt-800' : 'bg-slate-100 border-slate-300'}`}>{tag}</button>
                      );
                    })}
                </div>
             </FormSection>
          </div>
        );
      };

      // --- App 本体 ---
      const App = () => {
        const [form, setForm] = React.useState({ tags: [] });
        const [loading, setLoading] = React.useState(false);
        const [errors, setErrors] = React.useState({});

        React.useEffect(()=>{
          const draft = localStorage.getItem('tripRequest');
          if (draft) {
            try { const parsed = JSON.parse(draft); setForm(prev=>({
              ...prev,
              destination: parsed.destinations?.[0]?.city ? `${parsed.destinations?.[0]?.country}, ${parsed.destinations?.[0]?.city}` : prev.destination,
              start: parsed.dates?.start, end: parsed.dates?.end, origin: parsed.air?.origin,
              airBudget: parsed.air?.budget, airClass: parsed.air?.class, timePref: parsed.air?.timePref,
              hotelBudget: parsed.hotel?.budgetPerNight, hotelArea: parsed.hotel?.areaPref,
            })) } catch {}
          }
        },[]);

        const nights = React.useMemo(()=>{
          if (!form.start || !form.end) return 0;
          const s = new Date(form.start); const e = new Date(form.end); return Math.max(0, Math.round((e - s)/(1000*60*60*24)));
        },[form.start, form.end]);

        const policy = { airClassMax: 'Y', hotelCapPerNight: 20000 };

        const computeSummary = () => {
          const total = (form.airBudget||0) + (form.hotelBudget||0) * nights;
          const flags = [];
          if (form.airClass && form.airClass !== 'Y') flags.push({type:'warning', label:'ビジネスは要申請'});
          if ((form.hotelBudget||0) > policy.hotelCapPerNight) flags.push({type:'warning', label:'宿泊上限超過'});
          const policyScore = Math.max(0, 100 - flags.length * 15);
          return { total, airBudget: form.airBudget, hotelBudget: form.hotelBudget, policyScore, policyFlags: flags, risks: 0 };
        };

        const onChange = (patch) => setForm(prev=>({ ...prev, ...patch }));
        const onAddFixed = () => alert('モック: 予定を追加しました');

        const validate = () => {
          const e = {};
          if (!form.destination) e['目的地（国/都市）'] = '必須です';
          if (!form.start) e['出発日'] = '必須です';
          if (!form.end) e['帰着日'] = '必須です';
          if (!form.origin) e['発着希望空港'] = '必須です';
          if (!form.airBudget) e['航空券予算（総額）'] = '必須です';
          if (!form.hotelBudget) e['ホテル予算（1泊上限）'] = '必須です';
          setErrors(e);
          return Object.keys(e).length === 0;
        };

        const toJSON = () => ({
          projectId: 'P-NEWT-042',
          travelerRole: 'requester',
          destinations: [{ country: (form.destination||'').split(',')[0]?.trim()||'TW', city: (form.destination||'').split(',')[1]?.trim()||'' }],
          dates: { start: form.start, end: form.end, extension: null },
          air: { origin: form.origin, budget: Number(form.airBudget||0), class: form.airClass||'Y', timePref: form.timePref||'any' },
          hotel: { budgetPerNight: Number(form.hotelBudget||0), areaPref: form.hotelArea||'near_meeting' },
          fixedEvents: form.eventTitle ? [{ title: form.eventTitle, place: form.eventPlace||'', start: `${form.start}T${form.eventStart||'10:00'}`, end: `${form.start}T${form.eventEnd||'11:00'}` }] : [],
          plusNeeds: { tags: form.tags||[] },
          policy,
        });

        const handleDraft = () => {
          localStorage.setItem('tripRequest', JSON.stringify(toJSON()));
          alert('下書きを保存しました');
        };

        const handleNext = () => {
          if (!validate()) { window.scrollTo({top:0, behavior:'smooth'}); return; }
          setLoading(true);
          const json = toJSON();
          localStorage.setItem('tripRequest', JSON.stringify(json));
          setTimeout(()=>{ window.location.href = 'front_trip2.html'; }, 1200);
        };

        return (
          <div className="flex flex-col min-h-screen">
            <AppHeader />
            <main className="flex-grow w-full">
              <Container className="py-8">
                {/* 2カラムレイアウト */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  {/* 左ペイン: メイン操作 */}
                  <div className="lg:col-span-2">
                    <Step1Form value={form} onChange={onChange} errors={errors} onAddFixed={onAddFixed} />
                  </div>
                  {/* 右ペイン: サマリー */}
                  <div>
                    <SummaryCard summary={computeSummary()} />
                  </div>
                </div>
              </Container>
            </main>
            <AppFooter onBack={()=>history.back()} onDraft={handleDraft} onNext={handleNext} loading={loading} nextLabel="AIに提案させる" />
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
